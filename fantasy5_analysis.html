<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>California Fantasy 5 - Statistical Analysis</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
        }

        h1 { color: #2d3748; text-align: center; margin-bottom: 10px; font-size: 2.5em; }
        .subtitle { text-align: center; color: #718096; margin-bottom: 20px; font-size: 1.1em; }

        /* â”€â”€ Sync banner â”€â”€ */
        #syncBanner {
            display: flex; align-items: center; gap: 12px;
            background: #ebf4ff; border: 1px solid #bee3f8;
            border-radius: 10px; padding: 12px 18px;
            margin-bottom: 30px; font-size: 0.95em; color: #2b6cb0;
        }
        #syncBanner.success { background:#f0fff4; border-color:#9ae6b4; color:#276749; }
        #syncBanner.warning { background:#fffbeb; border-color:#fbd38d; color:#744210; }
        #syncBanner.error   { background:#fff5f5; border-color:#feb2b2; color:#742a2a; }

        .spinner {
            width:18px; height:18px;
            border:3px solid #bee3f8; border-top-color:#2b6cb0;
            border-radius:50%; animation:spin .8s linear infinite; flex-shrink:0;
        }
        @keyframes spin { to { transform:rotate(360deg); } }

        /* â”€â”€ Update modal â”€â”€ */
        #updateModal {
            display: none; position: fixed; inset: 0;
            background: rgba(0,0,0,0.5); z-index: 1000;
            align-items: center; justify-content: center;
        }
        #updateModal.open { display: flex; }
        .modal-box {
            background: white; border-radius: 16px;
            padding: 32px; max-width: 500px; width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
        }
        .modal-box h3 { color:#2d3748; margin-bottom:8px; font-size:1.4em; }
        .modal-box p  { color:#718096; margin-bottom:16px; font-size:.95em; }
        .modal-row { display:flex; gap:10px; align-items:center; margin-bottom:10px; flex-wrap:wrap; }
        .modal-row label { color:#4a5568; font-size:.9em; width:110px; flex-shrink:0; }
        .modal-row input {
            border:1px solid #e2e8f0; border-radius:8px; padding:8px 10px;
            font-size:.95em; width:60px; text-align:center;
        }
        .modal-row input:focus { outline:none; border-color:#667eea; box-shadow:0 0 0 2px rgba(102,126,234,.2); }
        .modal-actions { display:flex; gap:10px; margin-top:20px; justify-content:flex-end; }
        .btn-primary {
            background: linear-gradient(135deg,#667eea,#764ba2);
            color:white; border:none; border-radius:8px;
            padding:10px 22px; font-size:.95em; cursor:pointer;
        }
        .btn-primary:hover { opacity:.9; }
        .btn-secondary {
            background:#f7fafc; color:#4a5568; border:1px solid #e2e8f0;
            border-radius:8px; padding:10px 22px; font-size:.95em; cursor:pointer;
        }
        .btn-secondary:hover { background:#edf2f7; }
        #modalError { color:#e53e3e; font-size:.85em; margin-top:6px; display:none; }

        /* â”€â”€ Stats â”€â”€ */
        .stats-grid {
            display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
            gap:20px; margin-bottom:40px;
        }
        .stat-card {
            background:linear-gradient(135deg,#667eea,#764ba2);
            padding:25px; border-radius:15px; color:white;
            box-shadow:0 4px 15px rgba(102,126,234,.4);
        }
        .stat-label { font-size:.9em; opacity:.9; margin-bottom:8px; }
        .stat-value { font-size:2em; font-weight:bold; }

        .section { margin-bottom:40px; background:#f7fafc; padding:30px; border-radius:15px; }
        h2 { color:#2d3748; margin-bottom:20px; font-size:1.8em; border-bottom:3px solid #667eea; padding-bottom:10px; }

        .chart-container { position:relative; height:400px; margin-bottom:30px; }

        .number-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(80px,1fr)); gap:10px; margin-top:20px; }
        .number-cell { text-align:center; padding:15px; border-radius:10px; font-weight:bold; transition:transform .2s; cursor:pointer; }
        .number-cell:hover { transform:scale(1.05); }
        .hot  { background:linear-gradient(135deg,#f093fb,#f5576c); color:white; }
        .warm { background:linear-gradient(135deg,#ffecd2,#fcb69f); color:#2d3748; }
        .cool { background:linear-gradient(135deg,#a8edea,#fed6e3); color:#2d3748; }
        .cold { background:linear-gradient(135deg,#d299c2,#fef9d7); color:#2d3748; }

        .pattern-table, .combination-table {
            width:100%; border-collapse:collapse; margin-top:20px;
            background:white; border-radius:10px; overflow:hidden;
        }
        .combination-table { font-size:.9em; }
        .pattern-table th, .combination-table th {
            background:linear-gradient(135deg,#667eea,#764ba2);
            color:white; padding:12px 15px; text-align:left;
        }
        .pattern-table td, .combination-table td { padding:10px 15px; border-bottom:1px solid #e2e8f0; }
        .pattern-table tr:hover, .combination-table tr:hover { background:#f7fafc; }
        .frequent-row { background:#fef3e2; }

        .insight {
            background:white; border-left:4px solid #667eea;
            padding:15px 20px; margin:15px 0;
            border-radius:5px; box-shadow:0 2px 8px rgba(0,0,0,.1);
        }
        .insight-title { font-weight:bold; color:#667eea; margin-bottom:5px; }
    </style>
</head>
<body>

<!-- Update modal -->
<div id="updateModal">
    <div class="modal-box">
        <h3>ğŸ° New Draw Available</h3>
        <p id="modalPrompt">Enter the winning numbers for the missing draw date(s) to keep your analysis current.</p>
        <div id="modalFields"></div>
        <div id="modalError">âš ï¸ Please enter 5 valid numbers between 1â€“39, all different.</div>
        <div class="modal-actions">
            <button class="btn-secondary" onclick="dismissModal()">Skip for now</button>
            <button class="btn-primary"   onclick="submitModal()">Add &amp; Update</button>
        </div>
    </div>
</div>

<div class="container">
    <h1>ğŸ° California Fantasy 5</h1>
    <div class="subtitle" id="subtitleRange">Statistical Analysis Â· Latest 100 Draws</div>

    <div id="syncBanner">
        <div class="spinner" id="syncSpinner"></div>
        <span id="syncMsg">Loading draw dataâ€¦</span>
    </div>

    <div class="stats-grid">
        <div class="stat-card"><div class="stat-label">Total Draws Analyzed</div><div class="stat-value">100</div></div>
        <div class="stat-card"><div class="stat-label">Most Frequent Number</div><div class="stat-value" id="mostFrequent">-</div></div>
        <div class="stat-card"><div class="stat-label">Least Frequent Number</div><div class="stat-value" id="leastFrequent">-</div></div>
        <div class="stat-card"><div class="stat-label">Average Sum</div><div class="stat-value" id="avgSum">-</div></div>
    </div>

    <div class="section">
        <h2>ğŸ“Š Individual Number Frequency Distribution</h2>
        <div class="chart-container"><canvas id="frequencyChart"></canvas></div>
    </div>

    <div class="section">
        <h2>ğŸ”¥ Hot &amp; Cold Numbers</h2>
        <div class="insight">
            <div class="insight-title">Understanding Hot &amp; Cold Numbers</div>
            Hot numbers (red) appear most frequently in the last 100 draws; cold numbers (light) appear least frequently.
        </div>
        <div id="hotColdGrid" class="number-grid"></div>
    </div>

    <div class="section">
        <h2>ğŸ”¢ Number Combination Patterns</h2>
        <div class="insight">
            <div class="insight-title">ğŸ” Most Common Number Pairs</div>
            <div>These pairs have appeared together most frequently:</div>
            <div id="commonPairs" style="margin-top:10px;"></div>
        </div>
        <div class="insight">
            <div class="insight-title">ğŸ¯ Most Common Triplets</div>
            <div>These three-number combinations have appeared together most frequently:</div>
            <div id="commonTriplets" style="margin-top:10px;"></div>
        </div>
    </div>

    <div class="section">
        <h2>ğŸ“‹ Recent Draw History</h2>
        <table class="pattern-table">
            <thead><tr><th>Draw Date</th><th>Winning Numbers</th><th>Sum</th></tr></thead>
            <tbody id="recentDraws"></tbody>
        </table>
    </div>

    <div class="section">
        <h2>ğŸ”„ Number Reoccurrence Analysis</h2>
        <div class="insight">
            <div class="insight-title">Gap Analysis (Sorted by Avg Gap)</div>
            Numbers sorted by average gap between appearances â€” shorter gaps indicate more frequent reoccurrence. Top 10 highlighted.
        </div>
        <table class="combination-table">
            <thead>
                <tr><th>Number</th><th>Total Appearances</th><th>Avg Gap Between Draws</th><th>Last Seen</th><th>Draws Ago</th></tr>
            </thead>
            <tbody id="gapAnalysis"></tbody>
        </table>
    </div>

    <div class="section">
        <h2>ğŸ’¡ Key Statistical Insights</h2>
        <div id="insights"></div>
    </div>
</div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  SEED DATA â€” 100 draws, newest first (through Feb 10 2026)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SEED_DRAWS = [
    ["2026-02-10", [4, 5, 12, 26, 32]],
    ["2026-02-09", [2, 8, 11, 36, 37]],
    ["2026-02-08", [18, 20, 24, 29, 33]],
    ["2026-02-07", [8, 12, 15, 24, 34]],
    ["2026-02-06", [5, 11, 26, 28, 39]],
    ["2026-02-05", [8, 26, 28, 32, 38]],
    ["2026-02-04", [9, 11, 25, 26, 29]],
    ["2026-02-03", [5, 6, 13, 15, 23]],
    ["2026-02-02", [1, 8, 23, 24, 36]],
    ["2026-02-01", [6, 12, 19, 22, 25]],
    ["2026-01-31", [2, 14, 18, 20, 35]],
    ["2026-01-30", [9, 13, 18, 24, 28]],
    ["2026-01-29", [2, 4, 8, 17, 21]],
    ["2026-01-28", [5, 6, 13, 27, 32]],
    ["2026-01-27", [1, 4, 22, 33, 39]],
    ["2026-01-26", [1, 2, 5, 7, 20]],
    ["2026-01-25", [1, 14, 19, 27, 37]],
    ["2026-01-24", [15, 18, 25, 33, 35]],
    ["2026-01-23", [11, 14, 15, 20, 36]],
    ["2026-01-22", [6, 8, 11, 27, 28]],
    ["2026-01-21", [13, 14, 18, 26, 32]],
    ["2026-01-20", [7, 8, 13, 22, 28]],
    ["2026-01-19", [11, 19, 22, 27, 30]],
    ["2026-01-18", [16, 18, 19, 31, 37]],
    ["2026-01-17", [8, 18, 28, 33, 39]],
    ["2026-01-16", [3, 8, 16, 31, 33]],
    ["2026-01-15", [6, 18, 28, 32, 36]],
    ["2026-01-14", [2, 9, 12, 25, 39]],
    ["2026-01-13", [4, 9, 25, 27, 35]],
    ["2026-01-12", [13, 18, 27, 28, 35]],
    ["2026-01-11", [7, 16, 17, 19, 35]],
    ["2026-01-10", [12, 13, 15, 24, 34]],
    ["2026-01-09", [23, 25, 28, 29, 35]],
    ["2026-01-08", [2, 15, 19, 24, 36]],
    ["2026-01-07", [2, 3, 9, 11, 31]],
    ["2026-01-06", [1, 10, 28, 31, 39]],
    ["2026-01-05", [5, 9, 15, 21, 24]],
    ["2026-01-04", [9, 19, 20, 26, 32]],
    ["2026-01-03", [14, 17, 18, 19, 34]],
    ["2026-01-02", [3, 13, 22, 31, 38]],
    ["2026-01-01", [13, 14, 24, 25, 35]],
    ["2025-12-31", [1, 3, 9, 11, 21]],
    ["2025-12-30", [10, 12, 22, 28, 37]],
    ["2025-12-29", [1, 8, 13, 17, 20]],
    ["2025-12-28", [1, 21, 22, 33, 35]],
    ["2025-12-27", [8, 9, 20, 26, 36]],
    ["2025-12-26", [2, 6, 7, 8, 35]],
    ["2025-12-25", [5, 17, 20, 29, 38]],
    ["2025-12-24", [7, 11, 18, 28, 30]],
    ["2025-12-23", [5, 14, 15, 19, 26]],
    ["2025-12-22", [1, 14, 16, 18, 19]],
    ["2025-12-21", [11, 28, 29, 32, 37]],
    ["2025-12-20", [3, 10, 14, 26, 31]],
    ["2025-12-19", [8, 18, 23, 28, 38]],
    ["2025-12-18", [7, 12, 13, 21, 32]],
    ["2025-12-17", [3, 9, 19, 26, 31]],
    ["2025-12-16", [6, 15, 16, 22, 31]],
    ["2025-12-15", [9, 17, 22, 26, 36]],
    ["2025-12-14", [6, 16, 23, 31, 32]],
    ["2025-12-13", [2, 3, 22, 24, 32]],
    ["2025-12-12", [16, 18, 27, 32, 38]],
    ["2025-12-11", [7, 13, 23, 26, 30]],
    ["2025-12-10", [1, 2, 5, 10, 17]],
    ["2025-12-09", [10, 15, 16, 20, 33]],
    ["2025-12-08", [7, 31, 33, 35, 38]],
    ["2025-12-07", [11, 13, 14, 19, 39]],
    ["2025-12-06", [9, 11, 12, 13, 34]],
    ["2025-12-05", [9, 10, 16, 27, 36]],
    ["2025-12-04", [16, 21, 30, 33, 34]],
    ["2025-12-03", [6, 7, 28, 29, 32]],
    ["2025-12-02", [6, 16, 18, 20, 33]],
    ["2025-12-01", [1, 2, 20, 30, 38]],
    ["2025-11-30", [2, 5, 8, 24, 33]],
    ["2025-11-29", [2, 10, 27, 28, 34]],
    ["2025-11-28", [13, 14, 21, 23, 32]],
    ["2025-11-27", [10, 24, 28, 31, 37]],
    ["2025-11-26", [2, 3, 21, 25, 27]],
    ["2025-11-25", [3, 5, 7, 18, 24]],
    ["2025-11-24", [5, 17, 20, 36, 39]],
    ["2025-11-23", [3, 16, 21, 35, 38]],
    ["2025-11-22", [9, 11, 21, 31, 35]],
    ["2025-11-21", [10, 11, 17, 28, 33]],
    ["2025-11-20", [8, 12, 24, 36, 39]],
    ["2025-11-19", [1, 7, 9, 24, 27]],
    ["2025-11-18", [2, 3, 6, 12, 39]],
    ["2025-11-17", [1, 5, 7, 10, 11]],
    ["2025-11-16", [3, 6, 17, 20, 37]],
    ["2025-11-15", [4, 9, 13, 23, 35]],
    ["2025-11-14", [4, 13, 24, 32, 37]],
    ["2025-11-13", [6, 14, 16, 25, 35]],
    ["2025-11-12", [1, 13, 23, 29, 35]],
    ["2025-11-11", [3, 5, 8, 11, 28]],
    ["2025-11-10", [6, 15, 29, 31, 37]],
    ["2025-11-09", [5, 15, 21, 22, 24]],
    ["2025-11-08", [6, 10, 13, 14, 19]],
    ["2025-11-07", [9, 17, 31, 37, 38]],
    ["2025-11-06", [5, 6, 11, 15, 38]],
    ["2025-11-05", [11, 14, 24, 25, 36]],
    ["2025-11-04", [8, 15, 18, 23, 24]],
    ["2025-11-03", [7, 9, 20, 27, 36]],
    ["2025-11-02", [4, 11, 13, 33, 39]],
    ["2025-11-01", [1, 3, 11, 13, 32]]
];

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  STATE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let draws = [];
let freqChart = null;
let pendingDates = []; // dates needing user input
let pendingIdx = 0;    // which pending date we're on

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  HELPERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function todayPT() {
    // Returns YYYY-MM-DD in Pacific Time
    const now = new Date();
    const pt  = new Date(now.toLocaleString('en-US', { timeZone: 'America/Los_Angeles' }));
    const y   = pt.getFullYear();
    const m   = String(pt.getMonth() + 1).padStart(2, '0');
    const d   = String(pt.getDate()).padStart(2, '0');
    return `${y}-${m}-${d}`;
}

function drawAvailableForDate(dateStr) {
    // Draw is at 6:30 PM PT â€” if today, only available after 6:30 PM PT
    const today = todayPT();
    if (dateStr < today) return true;
    if (dateStr > today) return false;
    const now = new Date();
    const ptHour = Number(now.toLocaleString('en-US', { timeZone: 'America/Los_Angeles', hour: 'numeric', hour12: false }));
    const ptMin  = now.toLocaleString('en-US', { timeZone: 'America/Los_Angeles', minute: 'numeric' });
    return ptHour > 18 || (ptHour === 18 && Number(ptMin) >= 30);
}

function addDays(dateStr, n) {
    const d = new Date(dateStr + 'T12:00:00Z');
    d.setUTCDate(d.getUTCDate() + n);
    return d.toISOString().slice(0, 10);
}

function setBanner(msg, type = '') {
    const banner  = document.getElementById('syncBanner');
    const spinner = document.getElementById('syncSpinner');
    const msgEl   = document.getElementById('syncMsg');
    banner.className = type || '';
    spinner.style.display = (type === 'success' || type === 'error' || type === 'warning') ? 'none' : 'block';
    msgEl.textContent = msg;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  STORAGE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadFromStorage() {
    try {
        const result = await window.storage.get('fantasy5-draws');
        if (result && result.value) {
            const parsed = JSON.parse(result.value);
            if (Array.isArray(parsed) && parsed.length === 100) return parsed;
        }
    } catch (e) { /* key doesn't exist yet */ }
    return null;
}

async function saveToStorage(data) {
    try {
        await window.storage.set('fantasy5-draws', JSON.stringify(data));
    } catch (e) {
        console.warn('Storage save failed:', e);
    }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  MODAL â€” user entry for missing draws
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openModalForDate(dateStr) {
    document.getElementById('modalPrompt').textContent =
        `Enter the 5 winning numbers for ${dateStr} (calottery.com or CA Lottery app):`;

    const fields = document.getElementById('modalFields');
    fields.innerHTML = '';
    const row = document.createElement('div');
    row.className = 'modal-row';
    const lbl = document.createElement('label');
    lbl.textContent = dateStr;
    row.appendChild(lbl);
    for (let i = 1; i <= 5; i++) {
        const inp = document.createElement('input');
        inp.type = 'number'; inp.min = 1; inp.max = 39;
        inp.id = `modalNum${i}`; inp.placeholder = `#${i}`;
        inp.addEventListener('keydown', e => { if (e.key === 'Enter') submitModal(); });
        row.appendChild(inp);
    }
    fields.appendChild(row);

    document.getElementById('modalError').style.display = 'none';
    document.getElementById('updateModal').classList.add('open');
    document.getElementById('modalNum1').focus();
}

function dismissModal() {
    document.getElementById('updateModal').classList.remove('open');
    setBanner('âš ï¸ Some draws were skipped. Data may not be fully current.', 'warning');
}

function submitModal() {
    const nums = [];
    for (let i = 1; i <= 5; i++) {
        const v = parseInt(document.getElementById(`modalNum${i}`).value, 10);
        if (isNaN(v) || v < 1 || v > 39) { showModalError(); return; }
        nums.push(v);
    }
    if (new Set(nums).size !== 5) { showModalError(); return; }
    nums.sort((a, b) => a - b);

    const dateStr = pendingDates[pendingIdx];
    document.getElementById('updateModal').classList.remove('open');

    // Insert new draw, drop oldest, keep 100
    draws = [[dateStr, nums], ...draws].slice(0, 100);

    pendingIdx++;
    if (pendingIdx < pendingDates.length) {
        openModalForDate(pendingDates[pendingIdx]);
    } else {
        // All done â€” save and re-render
        saveToStorage(draws).then(() => {
            const added = pendingDates.length;
            setBanner(`âœ… Added ${added} new draw${added > 1 ? 's' : ''}. Dataset updated through ${draws[0][0]}.`, 'success');
            renderAll();
        });
    }
}

function showModalError() {
    document.getElementById('modalError').style.display = 'block';
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  SYNC CHECK
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function syncCheck() {
    const mostRecent = draws[0][0];
    const today      = todayPT();

    // Build list of dates that should have draws but aren't in our data
    const missing = [];
    let cursor = addDays(mostRecent, 1);
    while (cursor <= today) {
        if (drawAvailableForDate(cursor)) missing.push(cursor);
        cursor = addDays(cursor, 1);
    }

    if (missing.length === 0) {
        const drawTimeNote = (mostRecent === today)
            ? ' (today\'s draw not yet available â€” check back after 6:30 PM PT)'
            : '';
        setBanner(`âœ… Up to date through ${mostRecent}.${drawTimeNote}`, 'success');
        return;
    }

    // Prompt user to enter missing draws one at a time
    pendingDates = missing;
    pendingIdx   = 0;
    setBanner(`ğŸ“¥ ${missing.length} draw${missing.length > 1 ? 's' : ''} missing since ${mostRecent}. Enter the results below.`, 'warning');
    openModalForDate(pendingDates[0]);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  RENDER
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAll() {
    const newest = draws[0][0];
    const oldest = draws[draws.length - 1][0];
    document.getElementById('subtitleRange').textContent =
        `Statistical Analysis Â· Latest 100 Draws (${oldest} â†’ ${newest})`;

    const frequency   = {};
    const appearances = {};
    for (let i = 1; i <= 39; i++) { frequency[i] = 0; appearances[i] = []; }
    draws.forEach(([, numbers], idx) => {
        numbers.forEach(n => { frequency[n]++; appearances[n].push(idx); });
    });

    const sortedByFreq = Object.entries(frequency).sort((a, b) => b[1] - a[1]);
    document.getElementById('mostFrequent').textContent  = `${sortedByFreq[0][0]} (${sortedByFreq[0][1]}Ã—)`;
    document.getElementById('leastFrequent').textContent = `${sortedByFreq[sortedByFreq.length-1][0]} (${sortedByFreq[sortedByFreq.length-1][1]}Ã—)`;

    const avgSum = draws.reduce((acc, [, nums]) => acc + nums.reduce((a, b) => a + b, 0), 0) / draws.length;
    document.getElementById('avgSum').textContent = avgSum.toFixed(1);

    // Chart
    if (freqChart) freqChart.destroy();
    freqChart = new Chart(document.getElementById('frequencyChart').getContext('2d'), {
        type: 'bar',
        data: {
            labels: Object.keys(frequency),
            datasets: [{ label: 'Times Drawn', data: Object.values(frequency),
                backgroundColor: 'rgba(102,126,234,0.8)', borderColor: 'rgba(102,126,234,1)', borderWidth: 1 }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { title: { display: true, text: 'Number Frequency Across 100 Draws' } },
            scales: {
                y: { beginAtZero: true, title: { display: true, text: 'Times Drawn' } },
                x: { title: { display: true, text: 'Number (1â€“39)' } }
            }
        }
    });

    // Hot/cold
    const hotColdGrid = document.getElementById('hotColdGrid');
    hotColdGrid.innerHTML = '';
    sortedByFreq.forEach(([num, freq], idx) => {
        const div = document.createElement('div');
        div.className = 'number-cell ' + (idx < 10 ? 'hot' : idx < 20 ? 'warm' : idx < 30 ? 'cool' : 'cold');
        div.innerHTML = `<div style="font-size:1.4em">${num}</div><div style="font-size:0.8em">${freq}Ã—</div>`;
        hotColdGrid.appendChild(div);
    });

    // Pairs
    const pairs = {};
    draws.forEach(([, numbers]) => {
        for (let i = 0; i < numbers.length; i++)
            for (let j = i + 1; j < numbers.length; j++) {
                const k = [numbers[i], numbers[j]].sort((a, b) => a - b).join('-');
                pairs[k] = (pairs[k] || 0) + 1;
            }
    });
    document.getElementById('commonPairs').innerHTML = Object.entries(pairs)
        .sort((a, b) => b[1] - a[1]).slice(0, 10)
        .map(([p, c]) => `<strong>${p}</strong> appeared together ${c} times`).join('<br>');

    // Triplets
    const triplets = {};
    draws.forEach(([, numbers]) => {
        for (let i = 0; i < numbers.length; i++)
            for (let j = i + 1; j < numbers.length; j++)
                for (let k = j + 1; k < numbers.length; k++) {
                    const key = [numbers[i], numbers[j], numbers[k]].sort((a, b) => a - b).join('-');
                    triplets[key] = (triplets[key] || 0) + 1;
                }
    });
    document.getElementById('commonTriplets').innerHTML = Object.entries(triplets)
        .sort((a, b) => b[1] - a[1]).slice(0, 8)
        .map(([t, c]) => `<strong>${t}</strong> appeared together ${c} times`).join('<br>');

    // Recent draws
    const recentTbody = document.getElementById('recentDraws');
    recentTbody.innerHTML = '';
    draws.slice(0, 25).forEach(([date, numbers]) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${date}</td><td><strong>${numbers.join(', ')}</strong></td><td>${numbers.reduce((a, b) => a + b, 0)}</td>`;
        recentTbody.appendChild(tr);
    });

    // Gap analysis
    const gapData = [];
    for (let num = 1; num <= 39; num++) {
        const app = appearances[num];
        let avgGap = null;
        if (app.length > 1) {
            let total = 0;
            for (let i = 1; i < app.length; i++) total += app[i] - app[i - 1];
            avgGap = total / (app.length - 1);
        }
        gapData.push({ num, freq: frequency[num], avgGap, lastIdx: app.length > 0 ? app[app.length - 1] : -1 });
    }
    gapData.sort((a, b) => {
        if (a.avgGap === null && b.avgGap === null) return 0;
        if (a.avgGap === null) return 1;
        if (b.avgGap === null) return -1;
        return a.avgGap - b.avgGap;
    });

    const gapTbody = document.getElementById('gapAnalysis');
    gapTbody.innerHTML = '';
    gapData.forEach((d, idx) => {
        const tr = document.createElement('tr');
        if (idx < 10 && d.avgGap !== null) tr.className = 'frequent-row';
        tr.innerHTML = `
            <td><strong>${d.num}</strong></td>
            <td>${d.freq}</td>
            <td>${d.avgGap !== null ? d.avgGap.toFixed(1) + ' draws' : 'N/A (1 appearance)'}</td>
            <td>${d.lastIdx >= 0 ? draws[d.lastIdx][0] : 'â€”'}</td>
            <td>${d.lastIdx >= 0 ? d.lastIdx : 'â€”'}</td>`;
        gapTbody.appendChild(tr);
    });

    // Insights
    const insightsDiv = document.getElementById('insights');
    insightsDiv.innerHTML = '';
    const shortGap  = gapData.filter(d => d.avgGap !== null).slice(0, 5).map(d => `${d.num} (${d.avgGap.toFixed(1)})`).join(', ');
    const topPair    = Object.entries(pairs).sort((a, b) => b[1] - a[1])[0];
    const topTriplet = Object.entries(triplets).sort((a, b) => b[1] - a[1])[0];
    [
        `Average sum of winning numbers is ${avgSum.toFixed(1)} (theoretical random average â‰ˆ 100)`,
        `Hottest numbers: ${sortedByFreq.slice(0, 5).map(([n]) => n).join(', ')}`,
        `Coldest numbers: ${sortedByFreq.slice(-5).map(([n]) => n).join(', ')}`,
        `Shortest reoccurrence gaps: ${shortGap}`,
        `Most common pair: ${topPair[0]} (${topPair[1]} times)`,
        `Most common triplet: ${topTriplet[0]} (${topTriplet[1]} times)`
    ].forEach(text => {
        const d = document.createElement('div');
        d.className = 'insight';
        d.innerHTML = `<div class="insight-title">ğŸ’¡ Insight</div>${text}`;
        insightsDiv.appendChild(d);
    });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  BOOT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(async () => {
    setBanner('Loading draw dataâ€¦');

    // Try storage first, fall back to seed
    const stored = await loadFromStorage();
    draws = stored || SEED_DRAWS;

    // If using seed for the first time, persist it
    if (!stored) await saveToStorage(draws);

    renderAll();
    await syncCheck();
})();
</script>
</body>
</html>
